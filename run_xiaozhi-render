#!/data/data/com.termux/files/usr/bin/bash
# =============================================
# Auto setup & start Xiaozhi + MCP services
# For Android Termux
# Author: GPT-5 setup script for Nguyen Anh Tuan
# =============================================

set -e

echo "ğŸš€ Báº¯t Ä‘áº§u khá»Ÿi Ä‘á»™ng Xiaozhi + MCP..."
sleep 1

# === Cáº­p nháº­t Termux & cÃ i Node.js + Git + Python náº¿u chÆ°a cÃ³ ===
pkg update -y && pkg upgrade -y
pkg install -y nodejs git python wget curl

# === Clone repo Xiaozhi-render ===
if [ ! -d "$HOME/xiaozhi-render" ]; then
  echo "ğŸ“¦ Táº£i mÃ£ nguá»“n tá»« GitHub..."
  git clone https://github.com/nguyenanhtuan2005/xiaozhi-render.git $HOME/xiaozhi-render
fi
cd $HOME/xiaozhi-render

# === CÃ i Ä‘áº·t dependencies MCP ===
echo "ğŸ“¥ CÃ i cÃ¡c package MCP..."
cd $HOME/mcp-google-custom-search-server && npm install
cd $HOME/world-news-api-mcp && npm install

# === Quay láº¡i thÆ° má»¥c chÃ­nh ===
cd $HOME/xiaozhi-render

# === Kiá»ƒm tra file cáº¥u hÃ¬nh Xiaozhi ===
if [ ! -f "$HOME/xiaozhi.config.json" ]; then
  echo "âš ï¸ KhÃ´ng tháº¥y file cáº¥u hÃ¬nh ~/xiaozhi.config.json, Ä‘ang táº£i vá»..."
  wget -O $HOME/xiaozhi.config.json https://raw.githubusercontent.com/nguyenanhtuan2005/xiaozhi-render/main/xiaozhi.config.json
fi

# === CÃ i Ä‘áº·t Xiaozhi client náº¿u chÆ°a cÃ³ ===
if ! command -v xiaozhi &> /dev/null; then
  echo "ğŸ“¦ Äang cÃ i Xiaozhi client..."
  npm install -g xiaozhi-client
fi

# === Khá»Ÿi cháº¡y cÃ¡c MCP server ===
echo "ğŸ›°ï¸ Khá»Ÿi Ä‘á»™ng MCP Google Custom Search..."
node /home/nguyenanhtuan2005/mcp-google-custom-search-server/build/index.js &
GOOGLE_PID=$!

echo "ğŸ›°ï¸ Khá»Ÿi Ä‘á»™ng MCP World News API..."
node /home/nguyenanhtuan2005/world-news-api-mcp/dist/index.js &
NEWS_PID=$!

sleep 3

# === Khá»Ÿi cháº¡y Xiaozhi chÃ­nh ===
echo "ğŸ¤– Khá»Ÿi Ä‘á»™ng Xiaozhi client..."
export XIAOZHI_CONFIG=$HOME/xiaozhi.config.json
xiaozhi start &

# === Giá»¯ tiáº¿n trÃ¬nh cháº¡y mÃ£i ===
echo "âœ… Táº¥t cáº£ dá»‹ch vá»¥ Ä‘Ã£ khá»Ÿi Ä‘á»™ng xong!"
echo "ğŸŸ¢ Xiaozhi Ä‘ang cháº¡y ná»n vá»›i MCP Google + World News."
echo "Nháº¥n CTRL+C Ä‘á»ƒ dá»«ng toÃ n bá»™."
wait $GOOGLE_PID $NEWS_PID
